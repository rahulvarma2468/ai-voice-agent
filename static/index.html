<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI LLM Voice Agent & Echo Bot v2</title>
<style>
  body {
    min-height: 100vh;
    margin: 0;
    display: flex;
    justify-content: center;
    align-items: center;
    font-family: 'Segoe UI', Arial, sans-serif;
    background:
      linear-gradient(120deg, rgba(25,8,49,0.72) 0%, rgba(34,28,62,0.70) 100%),
      url('background.jpg') no-repeat center center fixed;
    background-size: cover;
    color: #fafbfc;
  }
  .glass-card {
    background: rgba(24, 19, 50, 0.65);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 26px;
    box-shadow: 0 4px 64px 0 #0ff1ff77, 0 1.5px 13px #971be930;
    padding: 2.8rem 1.9rem 2rem 1.9rem;
    max-width: 500px;
    width: 95vw;
    margin: 24px auto;
    display: flex;
    flex-direction: column;
    gap: 2rem;
    border: 1.5px solid rgba(52, 5, 99, 0.16);
  }
  .greeting {
    font-size: 1.17rem;
    font-weight: 500;
    color: #7de7f7;
    text-shadow: 0 2px 10px #3de0ff50;
    text-align: center;
  }
  h2 {
    text-align: center;
    color: #e7b8fe;
    font-weight: 700;
    font-size: 1.5rem;
    text-shadow: 0 2px 12px #c472fc99;
  }
  .input-row {
    display: flex;
    gap: 0.7rem;
  }
  input[type="text"] {
    flex: 1;
    font-size: 1rem;
    border: 1.5px solid #5935ba;
    padding: 0.9rem 1rem;
    border-radius: 14px;
    background: rgba(44,42,72,0.32);
    color: #f6f5ff;
  }
  button {
    background: linear-gradient(90deg, #16c7ff 30%, #a460f9 90%);
    color: #fff;
    border: none;
    font-weight: 600;
    border-radius: 12px;
    cursor: pointer;
  }
  .status { text-align: center; min-height: 1.3em; font-weight: 500; }
  .status.error { color: #ff91b8; }
  .status.success { color: #59ecc5; }
  .spinner { display: none; }
  .chat-history {
    max-height: 200px;
    overflow-y: auto;
    background: rgba(255,255,255,0.05);
    padding: 10px;
    border-radius: 10px;
    display: flex;
    flex-direction: column;
  }
  .bubble {
    padding: 6px 10px;
    border-radius: 8px;
    margin: 4px 0;
    max-width: 85%;
  }
  .user { background: rgba(0,255,255,0.15); align-self: flex-end; }
  .ai { background: rgba(160,100,255,0.15); align-self: flex-start; }
</style>
</head>
<body>
<div class="glass-card">
  <div class="greeting" id="greeting"></div>
  <h2>AI LLM Voice Agent & Echo Bot v2</h2>

  <!-- TTS Section -->
  <div class="input-row">
    <input id="tts-input" type="text" placeholder="Type something to speak..." maxlength="240" />
    <button id="tts-btn" onclick="generateAudio()">Speak</button>
  </div>
  <div id="status" class="status"></div>
  <div class="spinner" id="spinner"></div>
  <div>
    <audio id="audio-player" controls hidden></audio>
  </div>

  <!-- Conversation Section -->
  <div class="echo-section">
    <h1>AI Conversation</h1>
    <div id="chat-history" class="chat-history"></div>
    <div class="echo-btn-row">
      <button id="start-record" onclick="startRecording()">Start Recording</button>
      <button id="stop-record" onclick="stopRecording()" disabled>Stop Recording</button>
    </div>
    <div id="echo-status" class="status"></div>
    <div>
      <audio id="echo-audio" controls hidden></audio>
    </div>
  </div>
</div>

<script>
// Greeting
document.getElementById('greeting').textContent = (() => {
  const hr = new Date().getHours();
  if (hr < 12) return "Good morning, Voice Explorer! 🌞";
  if (hr < 18) return "Good afternoon, Voice Explorer! ☀️";
  return "Good evening, Voice Explorer! 🌙";
})();

// Session ID in URL
function getSessionId(){
  const params = new URLSearchParams(window.location.search);
  let sid = params.get('session');
  if(!sid){
    sid = Math.random().toString(36).substring(2,12);
    params.set('session', sid);
    window.location.search = params.toString();
  }
  return sid;
}
const sessionId = getSessionId();

// TTS
const input = document.getElementById('tts-input');
const btn = document.getElementById('tts-btn');
const statusEl = document.getElementById('status');
const audioEl = document.getElementById('audio-player');
const spinner = document.getElementById('spinner');

function setLoading(v){ spinner.style.display = v ? 'block' : 'none'; btn.disabled = v; }

async function generateAudio(){
  const text = input.value.trim();
  audioEl.hidden = true;
  statusEl.textContent = '';
  if(!text){ statusEl.textContent = 'Please enter some text.'; statusEl.classList.add('error'); return;}
  setLoading(true); statusEl.textContent = 'Generating audio...';
  try{
    const res = await fetch('/generate-audio',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({text})});
    const data = await res.json();
    if(data.audioUrl){
      audioEl.src = data.audioUrl; audioEl.hidden=false; audioEl.load(); audioEl.play();
      statusEl.textContent='Audio ready!'; statusEl.classList.add('success');
    } else { statusEl.textContent='Failed to generate audio.'; statusEl.classList.add('error'); }
  }catch(e){ statusEl.textContent='Network or server error.'; statusEl.classList.add('error'); }
  finally{ setLoading(false); }
}

// Conversation Bot
let mediaRecorder, audioChunks=[];
const startBtn = document.getElementById('start-record');
const stopBtn = document.getElementById('stop-record');
const echoStatus = document.getElementById('echo-status');
const echoAudio = document.getElementById('echo-audio');

function renderChat(history){
  const chatDiv = document.getElementById('chat-history');
  chatDiv.innerHTML = '';
  history.forEach(msg => {
    const div = document.createElement('div');
    div.className = 'bubble ' + (msg.role === 'user' ? 'user' : 'ai');
    div.textContent = `${msg.role === 'user' ? '🧑 You' : '🤖 AI'}: ${msg.content || ''}`;
    chatDiv.appendChild(div);
  });
  chatDiv.scrollTop = chatDiv.scrollHeight;
}

function startRecording(){
  echoStatus.textContent = '';
  echoAudio.hidden = true; echoAudio.src = '';
  if (!navigator.mediaDevices){
    echoStatus.textContent = "Browser doesn't support audio recording."; echoStatus.classList.add('error'); return;
  }
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream=>{
    mediaRecorder = new MediaRecorder(stream);
    audioChunks=[];
    mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
    mediaRecorder.onstop = () => { const audioBlob = new Blob(audioChunks,{type:'audio/webm'}); sendToAgent(audioBlob); };
    mediaRecorder.start();
    startBtn.disabled = true; stopBtn.disabled = false;
    echoStatus.textContent = "Recording...";
  }).catch(()=>{ echoStatus.textContent="Microphone access denied."; echoStatus.classList.add('error'); });
}

function stopRecording(){
  if(mediaRecorder && mediaRecorder.state === "recording"){
    mediaRecorder.stop();
    startBtn.disabled = false; stopBtn.disabled = true;
    echoStatus.textContent = "Processing with AI...";
  }
}

function sendToAgent(audioBlob){
  echoStatus.textContent = "Thinking and responding...";
  const formData = new FormData();
  formData.append('file', audioBlob, `agent_${Date.now()}.webm`);
  fetch(`/agent/chat/${sessionId}`,{method:'POST',body:formData})
    .then(r=>r.json())
    .then(res=>{
      if(res.history) renderChat(res.history);
      if(res.audioUrls && res.audioUrls.length>0){
        echoAudio.src = res.audioUrls[0];
        echoAudio.hidden = false; echoAudio.load(); echoAudio.play();
      }
      if(res.fallback){
        echoStatus.textContent = `⚠️ Fallback: ${res.llmText}`;
        echoStatus.classList.add('error');
      } else {
        echoStatus.textContent = "AI responded!"; echoStatus.classList.add('success');
      }
      echoAudio.onended = () => setTimeout(()=>startRecording(),500);
    })
    .catch(()=>{ echoStatus.textContent = "Error contacting AI."; echoStatus.classList.add('error'); });
}
</script>
</body>
</html>
